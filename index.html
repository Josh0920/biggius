<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Koine Greek ‚Ä¢ Study</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#121d3d;
      --card2:#0f1a3a;
      --line:rgba(170,190,255,.16);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);

      --brand:#6b8cff;
      --brand2:#91a9ff;

      --ok:#1f7a3f;
      --bad:#b12a2a;
      --warn:#c97b1c;

      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(107,140,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(145,169,255,.18), transparent 55%),
        linear-gradient(180deg, #070b16 0%, #0b1020 80%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
    }

    .app{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }

    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ order: 2; }
      .main{ order: 1; }
    }

    .sidebar{
      background: rgba(15,23,48,.65);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .brand{
      padding: 16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:12px;
      align-items:center;
    }

    .logo{
      width: 40px; height: 40px;
      border-radius: 12px;
      background:
        linear-gradient(135deg, rgba(107,140,255,.95), rgba(145,169,255,.7));
      display:grid;
      place-items:center;
      box-shadow: 0 12px 30px rgba(107,140,255,.22);
      font-weight: 800;
      letter-spacing:.2px;
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      line-height: 1.2;
    }
    .brand p{
      margin:4px 0 0;
      color:var(--muted);
      font-size: 12px;
    }

    .sideSection{ padding: 14px 14px 6px; }
    .sideLabel{ font-size: 12px; color:var(--muted); margin: 0 0 10px; }

    .modeList{ display:flex; flex-direction:column; gap:8px; }
    .modeBtn{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid transparent;
      background: rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition: .14s ease;
    }
    .modeBtn:hover{
      background: rgba(255,255,255,.06);
      transform: translateY(-1px);
    }
    .modeBtn.active{
      background: rgba(107,140,255,.16);
      border-color: rgba(107,140,255,.32);
    }
    .modeBtn .left{
      display:flex; gap:10px; align-items:center;
      font-size: 13px;
    }
    .badge{
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--muted);
    }

    .prefs{
      padding: 14px;
      border-top:1px solid var(--line);
    }
    .prefRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 9px 0;
      border-bottom:1px dashed rgba(170,190,255,.14);
    }
    .prefRow:last-child{ border-bottom:none; }
    .prefRow label{ color:var(--muted); font-size:12px; }
    select, input[type="number"], input[type="text"]{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      outline:none;
      font-size: 13px;
      min-width: 130px;
    }

    .hintBox{
      padding: 14px;
      border-top:1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hintBox code{ font-family: var(--mono); color: rgba(234,240,255,.9); }

    /* MAIN */
    .main{
      display:flex;
      flex-direction:column;
      gap: 16px;
    }

    .topbar{
      background: rgba(15,23,48,.65);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px 14px 12px;
      overflow:hidden;
    }

    .topRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .sessionTitle{
      display:flex; gap:10px; align-items:center;
    }
    .sessionTitle .title{
      margin:0;
      font-size: 14px;
    }
    .sessionTitle .sub{
      margin:3px 0 0;
      color:var(--muted);
      font-size: 12px;
    }

    .stats{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      padding: 7px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    .streak{
      color: rgba(255,255,255,.9);
      background: rgba(201,123,28,.16);
      border-color: rgba(201,123,28,.35);
    }

    .progressBar{
      margin-top: 12px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(170,190,255,.12);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(107,140,255,.9), rgba(145,169,255,.8));
      border-radius: 999px;
      transition: width .25s ease;
    }

    .stage{
      background: rgba(15,23,48,.65);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .stageHeader{
      padding: 14px 16px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .stageHeader h2{
      margin:0;
      font-size: 15px;
    }
    .stageHeader .mini{
      color: var(--muted);
      font-size: 12px;
    }

    .stageBody{ padding: 16px; }

    /* Flashcard-like prompt */
    .promptCard{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(170,190,255,.14);
      border-radius: 22px;
      padding: 18px 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
      position: relative;
      overflow:hidden;
    }

    .promptTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }

    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(170,190,255,.14);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    .big{
      font-size: 34px;
      letter-spacing: .4px;
      margin: 6px 0 0;
    }

    .smallMuted{
      margin: 10px 0 0;
      font-size: 13px;
      color: var(--muted);
    }

    .actionsRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 14px;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(170,190,255,.16);
      transition: .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn.primary{
      background: rgba(107,140,255,.22);
      border-color: rgba(107,140,255,.35);
    }
    .btn.primary:hover{ background: rgba(107,140,255,.28); }

    /* Multiple choice options */
    .optGrid{
      margin-top: 14px;
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 840px){ .optGrid{ grid-template-columns: 1fr 1fr; } }

    .opt{
      text-align:left;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(170,190,255,.14);
      cursor:pointer;
      transition: .12s ease;
      position: relative;
      overflow:hidden;
    }
    .opt:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .opt:disabled{ cursor:not-allowed; opacity:.95; transform:none; }
    .opt.correct{
      background: rgba(31,122,63,.20);
      border-color: rgba(31,122,63,.55);
    }
    .opt.wrong{
      background: rgba(177,42,42,.20);
      border-color: rgba(177,42,42,.55);
    }
    .opt .k{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,240,255,.75);
      margin-right: 8px;
    }

    /* Chart quiz */
    .chartWrap{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){ .chartWrap{ grid-template-columns: 1.2fr .8fr; } }

    .chartCard{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(170,190,255,.14);
      border-radius: 20px;
      padding: 14px;
      overflow:hidden;
    }
    .chartCard h3{
      margin: 0 0 6px;
      font-size: 14px;
    }
    .chartCard p{
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .chartTable{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(170,190,255,.12);
    }
    .chartTable th, .chartTable td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(170,190,255,.10);
      border-right: 1px solid rgba(170,190,255,.10);
      vertical-align: middle;
      font-size: 13px;
    }
    .chartTable th{
      background: rgba(255,255,255,.03);
      color: rgba(234,240,255,.85);
      font-weight: 650;
      font-size: 12px;
    }
    .chartTable tr:last-child td{ border-bottom:none; }
    .chartTable td:last-child, .chartTable th:last-child{ border-right:none; }

    .slot{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 92px;
      padding: 9px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px dashed rgba(170,190,255,.30);
      color: rgba(234,240,255,.65);
      transition: .12s ease;
      user-select:none;
      cursor:pointer;
    }
    .slot.filled{
      border-style: solid;
      color: rgba(234,240,255,.95);
      background: rgba(255,255,255,.05);
    }
    .slot.correct{ border-color: rgba(31,122,63,.75); background: rgba(31,122,63,.18); }
    .slot.wrong{ border-color: rgba(177,42,42,.75); background: rgba(177,42,42,.18); }
    .slot.active{
      outline: 2px solid rgba(107,140,255,.55);
      outline-offset: 2px;
    }

    .bank{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .bankTop{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .bankTop .mini{ color: var(--muted); font-size: 12px; }
    .bankBtns{ display:flex; gap:8px; flex-wrap:wrap; }

    .optPills{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      padding-top: 4px;
    }
    .pillOpt{
      cursor:pointer;
      border-radius: 999px;
      padding: 8px 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(170,190,255,.14);
      color: rgba(234,240,255,.92);
      font-size: 13px;
      transition: .12s ease;
      user-select:none;
    }
    .pillOpt:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .pillOpt.used{ opacity: .42; cursor:not-allowed; transform:none; }
    .pillOpt.correct{ background: rgba(31,122,63,.20); border-color: rgba(31,122,63,.55); }
    .pillOpt.wrong{ background: rgba(177,42,42,.20); border-color: rgba(177,42,42,.55); }

    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(15,23,48,.85);
      border: 1px solid rgba(170,190,255,.18);
      border-radius: 16px;
      padding: 12px 14px;
      color: rgba(234,240,255,.92);
      box-shadow: var(--shadow);
      max-width: 360px;
      transform: translateY(20px);
      opacity: 0;
      pointer-events: none;
      transition: .18s ease;
      backdrop-filter: blur(10px);
    }
    .toast.show{ transform: translateY(0); opacity: 1; }
    .toast strong{ display:block; margin-bottom: 4px; }
    .toast .tmuted{ color: var(--muted); font-size: 12px; }

    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 9px;
      border: 1px solid rgba(170,190,255,.16);
      background: rgba(255,255,255,.03);
      color: rgba(234,240,255,.85);
    }

    .footerRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    .linkish{ color: rgba(145,169,255,.95); text-decoration:none; }
    .linkish:hover{ text-decoration: underline; }
  </style>
</head>

<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">Œö</div>
        <div>
          <h1>Koine Greek Study</h1>
          <p>Quizlet-style practice ‚Ä¢ one page</p>
        </div>
      </div>

      <div class="sideSection">
        <p class="sideLabel">Study modes</p>
        <div class="modeList">
          <button class="modeBtn active" data-mode="vocab">
            <div class="left">üìö Vocab Quiz</div>
            <span class="badge" id="vocabBadge">MC</span>
          </button>
          <button class="modeBtn" data-mode="flash">
            <div class="left">üÉè Flashcards</div>
            <span class="badge">Flip</span>
          </button>
          <button class="modeBtn" data-mode="verbs">
            <div class="left">üß© Verb Charts</div>
            <span class="badge">Fill</span>
          </button>
          <button class="modeBtn" data-mode="pronouns">
            <div class="left">üß© Pronouns</div>
            <span class="badge">Fill</span>
          </button>
          <button class="modeBtn" data-mode="endings">
            <div class="left">üß© Endings</div>
            <span class="badge">Fill</span>
          </button>
        </div>
      </div>

      <div class="prefs">
        <div class="prefRow">
          <label>Shuffle</label>
          <select id="prefShuffle">
            <option value="on" selected>On</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div class="prefRow">
          <label>MC choices</label>
          <select id="prefChoices">
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
        <div class="prefRow">
          <label>Flashcard side</label>
          <select id="prefCardSide">
            <option value="greek" selected>Greek ‚Üí English</option>
            <option value="english">English ‚Üí Greek</option>
          </select>
        </div>
        <div class="prefRow">
          <label>Session size</label>
          <select id="prefSessionSize">
            <option value="20">20</option>
            <option value="30" selected>30</option>
            <option value="50">50</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>

      <div class="hintBox">
        <div><strong>Keyboard</strong></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <span class="kbd">1‚Äì6</span> <span class="kbd">answer</span>
          <span class="kbd">Space</span> <span class="kbd">flip</span>
          <span class="kbd">N</span> <span class="kbd">next</span>
          <span class="kbd">U</span> <span class="kbd">undo</span>
          <span class="kbd">R</span> <span class="kbd">reshuffle</span>
        </div>
        <div style="margin-top:10px;">
          Inspired by Quizlet‚Äôs interaction ideas like <em>flip + swipe flashcards</em> and <em>answer streaks</em>.  [oai_citation:1‚Ä°Quizlet Help Center](https://help.quizlet.com/hc/en-us/articles/360030988091-Studying-with-Flashcards?utm_source=chatgpt.com)
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- TOPBAR -->
      <section class="topbar">
        <div class="topRow">
          <div class="sessionTitle">
            <div>
              <div class="title" id="modeTitle"><strong>Vocab Quiz</strong></div>
              <div class="sub" id="modeSub">Multiple choice with instant feedback.</div>
            </div>
          </div>
          <div class="stats">
            <span class="pill" id="pillProgress">0 / 0</span>
            <span class="pill" id="pillScore">Score: 0</span>
            <span class="pill streak" id="pillStreak">Streak: 0</span>
          </div>
        </div>
        <div class="progressBar" aria-label="progress">
          <div class="progressFill" id="progressFill"></div>
        </div>
      </section>

      <!-- STAGE -->
      <section class="stage">
        <div class="stageHeader">
          <div>
            <h2 id="stageTitle">Answer the meaning</h2>
            <div class="mini" id="stageMini">Pick the correct English gloss.</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="btnReset">Reset</button>
            <button class="btn primary" id="btnNext" disabled>Next</button>
          </div>
        </div>

        <div class="stageBody" id="stageBody">
          <!-- dynamic -->
        </div>
      </section>

      <div class="footerRow">
        <div>Tip: keep a streak going ‚Äî Quizlet uses streaks in Learn to reward correct answers in a row.  [oai_citation:2‚Ä°Quizlet Help Center](https://help.quizlet.com/hc/en-ca/articles/40011154960653-Studying-with-Answer-Streaks?utm_source=chatgpt.com)</div>
        <div><a class="linkish" href="#" id="toggleAll">Show all vocab</a></div>
      </div>

    </main>
  </div>

  <div class="toast" id="toast">
    <strong id="toastTitle">Nice.</strong>
    <div class="tmuted" id="toastMsg">‚Äî</div>
  </div>

<script>
/* ===========================
   DATA (your sets)
   NOTE: This keeps your content the same as previously embedded.
   You can paste in additional charts/sets later.
=========================== */
const VOCAB = [{"g":"·ºÖŒ≥Œ≥ŒµŒªŒøœÇ","e":"angel, messenger"},{"g":"·ºÄŒºŒ∑ŒΩ","e":"amen"},{"g":"·ºÑŒΩŒ∏œÅœâœÄŒøœÇ","e":"man, mankind"},{"g":"·ºÄœÄœåœÉœÑŒøŒªŒøœÇ","e":"apostle"},{"g":"ŒìŒ±ŒªŒπŒªŒ±ŒØŒ±","e":"galilee"},{"g":"Œ≥œÅŒ±œÜŒÆ","e":"writing"},{"g":"Œ¥œåŒæŒ±","e":"glory, majesty, fame"},{"g":"·ºêŒ≥œé","e":"I"},{"g":"·ºîœÉœáŒ±œÑŒøœÇ","e":"last"},{"g":"Œ∂œâŒÆ","e":"life"},{"g":"Œ∏ŒµœåœÇ","e":"God"},{"g":"Œ∫Œ±ŒØ","e":"and, even, also, namely"},{"g":"Œ∫Œ±œÅŒ¥ŒØŒ±","e":"heart, inner self"},{"g":"Œ∫œåœÉŒºŒøœÇ","e":"world, universe, mankind"},{"g":"ŒªœåŒ≥ŒøœÇ","e":"word, Word, statement, message"},{"g":"œÄŒΩŒµœçŒºŒ±","e":"spirit, Spirit, wind, breath, inner self"},{"g":"œÄœÅŒøœÜŒÆœÑŒ∑œÇ","e":"prophet"},{"g":"œÉŒ¨Œ≤Œ≤Œ±œÑŒøŒΩ","e":"sabbath"},{"g":"œÜœâŒΩŒÆ","e":"sound, noise, voice"},{"g":"œáœÅŒπœÉœÑœåœÇ","e":"Christ, Messiah, Anointed One"},{"g":"·ºÄŒ≥Œ±œÄŒÆ","e":"love"},{"g":"·ºÇŒªŒªŒøœÇ","e":"other, another"},{"g":"Œ±·ΩêœÑœåœÇ","e":"singular: he, she, it (him, her); plural: they (them)"},{"g":"Œ≤Œ±œÉŒπŒªŒµŒØŒ±","e":"kingdom"},{"g":"Œ¥Œ≠","e":"but, and"},{"g":"·ºêŒΩ","e":"in, on, among"},{"g":"·ºíœÅŒ≥ŒøŒΩ","e":"work, deed, action"},{"g":"Œ∫Œ±ŒπœÅœåœÇ","e":"(appointed) time, season"},{"g":"ŒΩ·ø¶ŒΩ","e":"adverb: now; noun: the present"},{"g":"œå, ŒÆ, œÑœå","e":"the"},{"g":"·ΩÉœÑŒπ","e":"that, since, because"},{"g":"Œø·Ωê","e":"not"},{"g":"·Ω£œÅŒ±","e":"hour, occasion, moment"},{"g":"·ºÅŒºŒ±œÅœÑŒØŒ±","e":"sin"},{"g":"·ºÄœÅœáŒÆ","e":"beginning; ruler"},{"g":"Œ≥Œ¨œÅ","e":"for; then"},{"g":"Œµ·º∑œÄŒµŒΩ","e":"he/she/it said"},{"g":"Œµ·º∞œÇ","e":"into; in"},{"g":"·ºêŒæŒøœÖœÉŒØŒ±","e":"authority, power"},{"g":"Œµ·ΩêŒ±Œ≥Œ≥Œ≠ŒªŒπŒøŒΩ","e":"good news, Gospel"},{"g":"·º∏Œ∑œÉŒø·ø¶œÇ","e":"Jesus, Joshua"},{"g":"Œ∫œçœÅŒπŒøœÇ","e":"Lord; lord, master, sir"},{"g":"ŒºŒÆ","e":"not, lest"},{"g":"Œø·ΩêœÅŒ±ŒΩœåœÇ","e":"heaven; sky"},{"g":"Œø·ΩñœÑŒøœÇ, Œ±·ΩìœÑŒ∑, œÑŒø·ø¶œÑŒø","e":"singular: this (one); plural: these"},{"g":"œÉœç","e":"you (singular)"},{"g":"œÖ·º±œåœÇ","e":"son; descendant"},{"g":"·Ω£œÉœÑŒµ","e":"therefore, so that"},{"g":"·ºÄŒªŒªŒ¨ (·ºÄŒªŒª·æΩ)","e":"but, yet; rather"},{"g":"·ºÄœÄœå (·ºÄœÄ·æΩ, ·ºÄœÜ·æΩ)","e":"gen: (away) from"},{"g":"Œ¥ŒπŒ¨ (Œ¥Œπ·æΩ)","e":"gen: through; acc: on account of"},{"g":"Œµ·º∞ŒºŒØ","e":"I am, exist, live, am present"},{"g":"·ºêŒ∫ (·ºêŒæ)","e":"gen: from, out of"},{"g":"·º°ŒºŒ≠œÅŒ±","e":"day"},{"g":"·º¶ŒΩ","e":"he/she/it was"},{"g":"Œ∏Œ¨ŒªŒ±œÉœÉŒ±","e":"sea, lake"},{"g":"Œ∏Œ¨ŒΩŒ±œÑŒøœÇ","e":"death"},{"g":"·º≥ŒΩŒ±","e":"in order that; that; so that"},{"g":"·º∏œâŒ¨ŒΩŒΩŒ∑œÇ","e":"John"},{"g":"ŒªŒ≠Œ≥œâ","e":"I say, speak"},{"g":"ŒºŒµœÑŒ¨ (ŒºŒµœÑ·æΩ, ŒºŒµŒ∏·æΩ)","e":"gen: with; acc: after"},{"g":"Œø·º∞Œ∫ŒØŒ±","e":"house, home"},{"g":"Œø·º∂Œ∫ŒøœÇ","e":"house, home"},{"g":"·ΩÇœáŒªŒøœÇ","e":"crowd, multitude"},{"g":"œÄŒ±œÅŒ¨ (œÄŒ±œÅ·æΩ)","e":"gen: from; dat: beside, in the presence of; acc: alongside of"},{"g":"œÄŒ±œÅŒ±Œ≤ŒøŒªŒÆ","e":"parable"},{"g":"œÄœÅœåœÇ","e":"acc: to, towards; with"},{"g":"·ΩëœÄœå (·ΩëœÄ·æΩ, ·ΩëœÜ·æΩ)","e":"gen: by; acc: under"},{"g":"·ºÄŒ≥Œ±Œ∏œåœÇ","e":"good, useful"},{"g":"·ºÄŒ≥Œ±œÄŒ∑œÑœåœÇ","e":"beloved"},{"g":"·ºÉŒ≥ŒπŒøœÇ","e":"adjective: holy; plural noun: saints"},{"g":"Œ±·º∞œéŒΩŒπŒøœÇ","e":"eternal"},{"g":"·ºÄŒªŒªŒÆŒªœâŒΩ","e":"one another"},{"g":"·ºÄœÄŒµŒ∫œÅŒØŒ∏Œ∑","e":"he/she/it answered"},{"g":"Œ¥Œø·ø¶ŒªŒøœÇ","e":"slave; servant"},{"g":"·ºêŒ¨ŒΩ","e":"if; when"},{"g":"·ºêŒºœåœÇ, ·ºêŒºŒÆ, ·ºêŒºœåŒΩ","e":"my, mine"},{"g":"·ºêŒΩœÑŒøŒªŒÆ","e":"commandment"},{"g":"Œ∫Œ±Œ∏œéœÇ","e":"as, even as"},{"g":"Œ∫Œ±Œ∫œåœÇ","e":"bad, evil"},{"g":"ŒΩŒµŒ∫œÅœåœÇ","e":"adjective: dead; noun: dead body, corpse"},{"g":"œÄŒπœÉœÑœåœÇ","e":"faithful, believing"},{"g":"œÄŒøŒΩŒ∑œÅœåœÇ","e":"evil, bad"},{"g":"œÄœÅ·ø∂œÑŒøœÇ","e":"first; earlier"},{"g":"œÑœÅŒØœÑŒøœÇ","e":"third"},{"g":"Œµ·º∞","e":"if"},{"g":"Œµ·º∞ ŒºŒÆ","e":"except; if not"},{"g":"Œµ·º∑œÇ, ŒºŒØŒ±, ·ºìŒΩ","e":"one"},{"g":"·º¢Œ¥Œ∑","e":"now, already"},{"g":"·ΩÇŒΩŒøŒºŒ±, ‚ÄìŒ±œÑŒøœÇ, œÑœå","e":"name; reputation"},{"g":"Œø·ΩêŒ¥ŒµŒØœÇ, Œø·ΩêŒ¥ŒµŒºŒØŒ±, Œø·ΩêŒ¥Œ≠ŒΩ","e":"no one, none, nothing"},{"g":"œÄ·æ∂œÇ, œÄ·æ∂œÉŒ±, œÄ·æ∂ŒΩ","e":"singular: each, every; plural: all"},{"g":"œÄŒµœÅŒØ","e":"genitive: concerning, about; accusative: around"},{"g":"œÉŒ¨œÅŒæ, œÉŒ±œÅŒ∫œåœÇ, ·º°","e":"flesh; body"},{"g":"œÉœçŒΩ","e":"dative: with"},{"g":"œÉ·ø∂ŒºŒ±, ‚ÄìŒ±œÑŒøœÇ, œÑœå","e":"body"},{"g":"œÑŒ≠Œ∫ŒΩŒøŒΩ, ‚ÄìŒøœÖ, œÑœå","e":"child; descendant"},{"g":"œÑŒØœÇ, œÑŒØ","e":"Who? What? Which? Why?"},{"g":"œÑŒπœÇ, œÑŒπ","e":"Someone/thing; certain one/thing; anyone/thing"},{"g":"Œ£ŒØŒºœâŒΩ, ‚ÄîœâŒΩŒøœÇ, ·ΩÅ","e":"Simon"},{"g":"·ºÄŒ¥ŒµŒªœÜœåœÇ, Œø·ø¶, ·ΩÅ","e":"brother"},{"g":"·ºÄŒΩŒÆœÅ, ·ºÄŒΩŒ¥œÅœåœÇ, ·ΩÅ","e":"male; husband; man"},{"g":"Œ≠Œ∫Œ∫ŒªŒ∑œÉŒØŒ±, Œ±œÇ, ·º°","e":"a church; (the) Church; assembly, congregation"},{"g":"·ºêŒªœÄŒØœÇ, ŒØŒ¥ŒøœÇ, ·º°","e":"hope, expectation"},{"g":"·º°ŒºŒµ·øñœÇ","e":"we"},{"g":"Œ∏Œ≠ŒªŒ∑ŒºŒ±, Œ∏ŒµŒªŒÆŒºŒ±œÑŒøœÇ, œÑœå","e":"will, desire"},{"g":"·º∞Œ¥Œøœç","e":"See! Behold!"},{"g":"ŒºŒÆœÑŒ∑œÅ, ŒºŒ∑œÑœÅŒøœÇ, ·º°","e":"mother"},{"g":"œÄŒ±œÑŒÆœÅ, œÄŒ±œÑœÅœåœÇ, ·ΩÅ","e":"father"},{"g":"œÄŒØœÉœÑŒπœÇ, œÄŒØœÉœÑŒµœâœÇ, ·º°","e":"faith, belief; trust"},{"g":"·ΩìŒ¥œâœÅ, ·ΩìŒ¥Œ±œÑŒøœÇ, œÑœå","e":"water"},{"g":"·ΩëŒºŒµ·øñœÇ","e":"you (plural)"},{"g":"œÜ·ø∂œÇ, œÜœâœÑœåœÇ, œÑœå","e":"light"},{"g":"œáŒ¨œÅŒπœÇ, œáŒ¨œÅŒπœÑŒøœÇ, ·º°","e":"grace, favor, kindness"},{"g":"Œø·ΩñŒΩ","e":"therefore, accordingly; then"},{"g":"œÄŒ¨ŒªŒπŒΩ","e":"again"},{"g":"œÄŒøœçœÇ, œÄŒøŒ¥œåœÇ, ·ΩÅ","e":"foot"},{"g":"Œ≥œÖŒΩŒÆ, Œ≥œÖŒΩŒ±ŒπŒ∫œåœÇ, ·º°","e":"woman; wife"},{"g":"Œ¥ŒπŒ∫Œ±ŒπŒøœÉœçŒΩŒ∑","e":"righteousness"},{"g":"·ºëœÄœÑŒ¨","e":"seven"},{"g":"Œ∏œÅœåŒΩŒøœÇ","e":"throne"},{"g":"·º∏ŒµœÅŒøœÖœÉŒ±ŒªŒÆŒº, ·º°","e":"Jerusalem"},{"g":"Œ∫ŒµœÜŒ±ŒªŒÆ","e":"head"},{"g":"·ΩÅŒ¥œåœÇ","e":"way, road; journey, conduct"},{"g":"·ΩÉœÇ, ·º£, ·ΩÉ","e":"who (whom), which"},{"g":"·ΩÉœÑŒµ","e":"when"},{"g":"Œø·ΩìœÑœâœÇ","e":"thus, so; in this manner"},{"g":"·ø•·øÜŒºŒ±, Œ±œÑŒøœÇ, œÑœå","e":"word, saying"},{"g":"œáŒµŒØœÅ, œáŒµŒπœÅœåœÇ, ·º°","e":"hand"},{"g":"œàœÖœáŒÆ","e":"life; soul; self"},{"g":"·ºÄŒ∫Œøœçœâ","e":"I hear; learn, obey; understand"},{"g":"Œ≤ŒªŒ≠œÄœâ","e":"I see, look at"},{"g":"·ºíœáœâ","e":"I have, hold"},{"g":"Œªœçœâ","e":"I loose, untie, destroy"},{"g":"œÄŒπœÉœÑŒµœçœâ","e":"I believe, have faith (in), trust"},{"g":"œÑœåœÑŒµ","e":"then; thereafter"},{"g":"œáŒ±œÅŒ¨, ·æ∂œÇ, ·º°","e":"joy, delight"},{"g":"·ºÄŒ≥Œ±œÄŒ¨œâ","e":"I love, cherish"},{"g":"Œ∂Œ∑œÑŒ≠œâ","e":"I seek, desire, try to obtain"},{"g":"Œ∫Œ±ŒªŒ≠œâ","e":"I call, name, invite"},{"g":"ŒªŒ±ŒªŒ≠œâ","e":"I speak, say"},{"g":"Œø·º∂Œ¥Œ±","e":"I know, understand"},{"g":"œÄŒªŒ∑œÅœåœâ","e":"I fill, complete, fulfill"},{"g":"œÄŒøŒπŒ≠œâ","e":"I do, make"},{"g":"œÑŒ∑œÅŒ≠œâ","e":"I keep, guard, observe"},{"g":"Œ¥Œµ·øñ","e":"it is necessary"},{"g":"Œ¥œçŒΩŒ±ŒºŒ±Œπ","e":"I am able"},{"g":"·ºíœÅœáŒøŒºŒ±Œπ","e":"I come, go"},{"g":"ŒΩœçŒæ, ŒΩœÖŒ∫œÑœåœÇ, ·º°","e":"night"}];

const VERB_CHARTS = [
  { id:"pres_act", title:"Present Active Indicative", labels:["1st sg","2nd sg","3rd sg","1st pl","2nd pl","3rd pl"], forms:["œâ","ŒµŒπœÇ","ŒµŒπ","ŒøŒºŒµŒΩ","ŒµœÑŒµ","ŒøœÖœÉŒπ(ŒΩ)"] },
  { id:"pres_mp", title:"Present Middle/Passive Indicative", labels:["1st sg","2nd sg","3rd sg","1st pl","2nd pl","3rd pl"], forms:["ŒøŒºŒ±Œπ","·øÉ","ŒµœÑŒ±Œπ","ŒøŒºŒµŒ∏Œ±","ŒµœÉŒ∏Œµ","ŒøŒΩœÑŒ±Œπ"] },
  { id:"perf_act", title:"Perfect Active Indicative", labels:["1st sg","2nd sg","3rd sg","1st pl","2nd pl","3rd pl"], forms:["[redup][stem]Œ∫Œ±","[redup][stem]Œ∫Œ±œÇ","[redup][stem]Œ∫Œµ(ŒΩ)","[redup][stem]Œ∫Œ±ŒºŒµŒΩ","[redup][stem]Œ∫Œ±œÑŒµ","[redup][stem]Œ∫Œ±œÉŒπ(ŒΩ)"] },
];

const PRONOUN_CHARTS = [
  { id:"rel_m", title:"Relative Pronoun ‚Äî Masculine (·ΩÉœÇ)", labels:["Nom.S","Gen.S","Dat.S","Acc.S","Nom.Pl","Gen.Pl","Dat.Pl","Acc.Pl"], forms:["·ΩÉœÇ","Œø·Ωó","·æß","·ΩÉŒΩ","Œø·º≥","·ΩßŒΩ","Œø·º∑œÇ","Œø·ΩìœÇ"] },
  { id:"autos_m", title:"Œ±·ΩêœÑœåœÇ ‚Äî Masculine", labels:["Nom.S","Gen.S","Dat.S","Acc.S","Nom.Pl","Gen.Pl","Dat.Pl","Acc.Pl"], forms:["Œ±·ΩêœÑœåœÇ","Œ±·ΩêœÑŒø·ø¶","Œ±·ΩêœÑ·ø∑","Œ±·ΩêœÑœåŒΩ","Œ±·ΩêœÑŒøŒØ","Œ±·ΩêœÑ·ø∂ŒΩ","Œ±·ΩêœÑŒø·øñœÇ","Œ±·ΩêœÑŒøœçœÇ"] },
];

const ENDING_CHARTS = [
  { id:"article", title:"Article Endings (·ΩÅ / ·º° / œÑœå)", labels:["Nom.S","Gen.S","Dat.S","Acc.S","Nom.Pl","Gen.Pl","Dat.Pl","Acc.Pl"], forms:["·ΩÅ/·º°/œÑœå","œÑŒøœÖ/œÑŒ∑œÇ/œÑŒøœÖ","œÑ·ø≥/œÑ·øÉ/œÑ·ø≥","œÑœåŒΩ/œÑŒÆŒΩ/œÑœå","Œø·º±/Œ±·º±/œÑŒ¨","œÑœâŒΩ/œÑœâŒΩ/œÑœâŒΩ","œÑŒøŒπœÇ/œÑŒ±ŒπœÇ/œÑŒøŒπœÇ","œÑŒøœçœÇ/œÑŒ¨œÇ/œÑŒ¨"] },
];

/* ===========================
   HELPERS
=========================== */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

function shuffle(a){
  const b=a.slice();
  for(let i=b.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [b[i],b[j]]=[b[j],b[i]];
  }
  return b;
}

function toast(title,msg){
  $("#toastTitle").textContent=title;
  $("#toastMsg").textContent=msg;
  $("#toast").classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>$("#toast").classList.remove("show"), 1500);
}

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

/* ===========================
   GLOBAL STATE
=========================== */
let mode = "vocab";
let session = [];
let i = 0;
let score = 0;
let streak = 0;
let locked = false;

function prefShuffleOn(){ return $("#prefShuffle").value === "on"; }
function prefChoices(){ return Number($("#prefChoices").value); }
function prefSessionSize(){
  const v = $("#prefSessionSize").value;
  return v === "all" ? Infinity : Number(v);
}
function prefCardSide(){ return $("#prefCardSide").value; }

function buildSession(){
  const size = prefSessionSize();
  const base = prefShuffleOn() ? shuffle(VOCAB) : VOCAB.slice();
  session = base.slice(0, size === Infinity ? base.length : size);
  i = 0;
  score = 0;
  streak = 0;
  locked = false;
  updateTopbar();
  render();
}

function updateTopbar(){
  $("#pillProgress").textContent = `${Math.min(i+1, session.length)} / ${session.length}`;
  $("#pillScore").textContent = `Score: ${score}`;
  $("#pillStreak").textContent = `Streak: ${streak}`;
  const pct = session.length ? (Math.min(i, session.length) / session.length) * 100 : 0;
  $("#progressFill").style.width = `${clamp(pct,0,100)}%`;
}

function setMode(m){
  mode = m;
  $$(".modeBtn").forEach(b => b.classList.toggle("active", b.dataset.mode === m));
  $("#btnNext").disabled = true;
  $("#btnNext").textContent = "Next";
  $("#btnReset").textContent = "Reset";
  $("#toggleAll").style.display = (m==="vocab" || m==="flash") ? "inline" : "none";

  const titles = {
    vocab: ["Vocab Quiz","Multiple choice with instant feedback."],
    flash: ["Flashcards","Flip the card. Mark correct/incorrect."],
    verbs: ["Verb Charts","Fill blanks by clicking options in order."],
    pronouns: ["Pronouns","Fill the paradigm in order."],
    endings: ["Endings","Fill blanks (articles/case endings/etc.)."],
  };
  $("#modeTitle").innerHTML = `<strong>${titles[m][0]}</strong>`;
  $("#modeSub").textContent = titles[m][1];

  render();
}

/* ===========================
   RENDERERS
=========================== */
function render(){
  if(mode==="vocab") return renderVocab();
  if(mode==="flash") return renderFlash();
  if(mode==="verbs") return renderChartMode("verbs", VERB_CHARTS);
  if(mode==="pronouns") return renderChartMode("pronouns", PRONOUN_CHARTS);
  if(mode==="endings") return renderChartMode("endings", ENDING_CHARTS);
}

function renderVocab(){
  $("#stageTitle").textContent = "Answer the meaning";
  $("#stageMini").textContent = "Pick the correct English gloss. (1‚Äì6 keys)";
  $("#btnNext").disabled = true;

  const cur = session[i];
  if(!cur){
    $("#stageBody").innerHTML = doneHtml("Vocab complete", `Final score: ${score}/${session.length}.`);
    $("#btnNext").disabled = true;
    updateTopbar();
    return;
  }

  locked = false;
  updateTopbar();

  const n = prefChoices();
  const distract = shuffle(VOCAB.filter(v => v.g !== cur.g)).slice(0, Math.max(0,n-1));
  const choices = shuffle([cur, ...distr]);

  $("#stageBody").innerHTML = `
    <div class="promptCard">
      <div class="promptTop">
        <span class="chip">Greek ‚Üí English</span>
        <span class="chip">Choices: ${n}</span>
      </div>
      <div class="big">${cur.g}</div>
      <div class="smallMuted">Choose the best gloss.</div>

      <div class="optGrid" id="mcGrid">
        ${choices.map((c,idx)=>`
          <button class="opt" data-idx="${idx}" data-correct="${c.g===cur.g ? "1":"0"}">
            <span class="k">${idx+1}</span>${escapeHtml(c.e)}
          </button>
        `).join("")}
      </div>

      <div class="actionsRow">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnPeek">Peek answer</button>
          <button class="btn" id="btnShuffleOne">Shuffle choices</button>
        </div>
        <div class="chip">Shortcut: <span class="kbd">1‚Äì6</span></div>
      </div>
    </div>
  `;

  const grid = $("#mcGrid");
  const btns = Array.from(grid.querySelectorAll("button"));

  function grade(btn){
    if(locked) return;
    locked = true;

    const isCorrect = btn.dataset.correct === "1";
    btns.forEach(b => b.disabled = true);

    if(isCorrect){
      btn.classList.add("correct");
      score++;
      streak++;
      toast("Correct ‚úÖ", `Streak: ${streak}`);
    }else{
      btn.classList.add("wrong");
      streak = 0;
      const correctBtn = btns.find(b => b.dataset.correct === "1");
      if(correctBtn) correctBtn.classList.add("correct");
      toast("Not quite ‚ùå", `Streak reset.`);
    }

    $("#btnNext").disabled = false;
    $("#btnNext").focus();
    updateTopbar();
  }

  btns.forEach(b => b.addEventListener("click", ()=>grade(b)));

  $("#btnPeek").addEventListener("click", ()=>{
    const correctBtn = btns.find(b => b.dataset.correct === "1");
    toast("Answer", correctBtn ? correctBtn.textContent.replace(/^\d+\s?/,"") : "‚Äî");
  });

  $("#btnShuffleOne").addEventListener("click", ()=>{
    // re-render same prompt with new choice order
    renderVocab();
  });
}

function renderFlash(){
  $("#stageTitle").textContent = "Flashcards";
  $("#stageMini").textContent = "Flip with Space. Mark ‚úì or ‚úï. (N next)";
  $("#btnNext").disabled = true;

  const cur = session[i];
  if(!cur){
    $("#stageBody").innerHTML = doneHtml("Flashcards complete", `Score: ${score}/${session.length} (based on your ‚úì clicks).`);
    $("#btnNext").disabled = true;
    updateTopbar();
    return;
  }

  locked = false;
  updateTopbar();

  const side = prefCardSide(); // greek or english first
  const front = side === "greek" ? cur.g : cur.e;
  const back  = side === "greek" ? cur.e : cur.g;

  $("#stageBody").innerHTML = `
    <div class="promptCard" id="flashCard" style="cursor:pointer;">
      <div class="promptTop">
        <span class="chip">${side === "greek" ? "Greek ‚Üí English" : "English ‚Üí Greek"}</span>
        <span class="chip">Tap/click to flip</span>
      </div>

      <div class="big" id="flashFace">${escapeHtml(front)}</div>
      <div class="smallMuted" id="flashHint">Click to reveal the other side.</div>

      <div class="actionsRow">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="btnWrong">‚úï Missed</button>
          <button class="btn primary" id="btnRight">‚úì Got it</button>
        </div>
        <div class="chip">Shortcut: <span class="kbd">Space</span> flip ‚Ä¢ <span class="kbd">N</span> next</div>
      </div>
    </div>
  `;

  let flipped = false;

  function flip(){
    flipped = !flipped;
    $("#flashFace").innerHTML = escapeHtml(flipped ? back : front);
    $("#flashHint").textContent = flipped ? "Now decide: did you get it?" : "Click to reveal the other side.";
  }

  $("#flashCard").addEventListener("click", (e)=>{
    // avoid flipping when clicking buttons
    if(e.target.closest("button")) return;
    flip();
  });

  $("#btnRight").addEventListener("click", ()=>{
    score++;
    streak++;
    toast("Nice ‚úÖ", `Streak: ${streak}`);
    next();
  });
  $("#btnWrong").addEventListener("click", ()=>{
    streak = 0;
    toast("Logged ‚úï", `Keep going.`);
    next();
  });

  // Allow Next button to work here too
  $("#btnNext").disabled = false;
  $("#btnNext").textContent = "Next";
}

function doneHtml(title, subtitle){
  return `
    <div class="promptCard">
      <div class="promptTop">
        <span class="chip">Session complete</span>
      </div>
      <div class="big">${escapeHtml(title)}</div>
      <div class="smallMuted">${escapeHtml(subtitle)}</div>
      <div class="actionsRow" style="margin-top:16px;">
        <button class="btn primary" id="btnRestartInner">Restart</button>
      </div>
    </div>
  `;
}

function renderChartMode(which, charts){
  $("#stageTitle").textContent = "Fill the chart";
  $("#stageMini").textContent = "Click options in order. Click a filled blank to focus it. (U undo)";
  $("#btnNext").disabled = true;
  $("#btnNext").textContent = "Next";

  // current chart selection state per mode
  const key = `__chart_${which}`;
  const saved = window[key] || { chartId: charts[0].id, filled: [], used: new Set(), graded:false, focus:0, bank:[] };
  window[key] = saved;

  const chart = charts.find(c=>c.id===saved.chartId) || charts[0];

  if(!saved.bank.length || saved.bank.length !== chart.forms.length){
    saved.bank = shuffle(chart.forms.slice());
  }

  // build chart HTML
  const slots = chart.forms.map((_, idx)=>{
    const val = saved.filled[idx] ?? "";
    const cls = ["slot", val ? "filled":"", idx===saved.focus ? "active":""].join(" ");
    return `<span class="${cls}" data-slot="${idx}">${val ? escapeHtml(val) : "_____ "}</span>`;
  });

  $("#stageBody").innerHTML = `
    <div class="chartWrap">
      <div class="chartCard">
        <div class="promptTop" style="margin-bottom:10px;">
          <span class="chip">${escapeHtml(chart.title)}</span>
          <span class="chip">Filled ${saved.filled.length}/${chart.forms.length}</span>
        </div>

        ${chartTableHtml(chart, slots)}

        <div class="actionsRow">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <select id="chartSel"></select>
            <button class="btn" id="btnNewChart">Reshuffle</button>
            <button class="btn" id="btnClearChart">Clear</button>
            <button class="btn primary" id="btnGradeChart">Grade</button>
          </div>
          <div class="chip">Shortcut: <span class="kbd">U</span> undo ‚Ä¢ <span class="kbd">R</span> reshuffle</div>
        </div>

        <div class="smallMuted" id="chartStatus" style="margin-top:10px;"></div>
      </div>

      <div class="chartCard">
        <div class="bank">
          <div class="bankTop">
            <div>
              <h3 style="margin:0;">Option bank</h3>
              <div class="mini">Click the next correct form to fill the highlighted blank.</div>
            </div>
            <div class="bankBtns">
              <button class="btn" id="btnUndo">Undo</button>
              <button class="btn" id="btnReveal">Reveal next</button>
            </div>
          </div>

          <div class="optPills" id="bankPills"></div>

          <div class="smallMuted" style="margin-top:8px;">
            Pro move: click a blank to set the focus, then fill.
          </div>
        </div>
      </div>
    </div>
  `;

  // fill chart selector
  const sel = $("#chartSel");
  sel.innerHTML = charts.map(c=>`<option value="${c.id}" ${c.id===chart.id?"selected":""}>${escapeHtml(c.title)}</option>`).join("");

  sel.addEventListener("change", ()=>{
    saved.chartId = sel.value;
    saved.filled = [];
    saved.used = new Set();
    saved.graded = false;
    saved.focus = 0;
    saved.bank = [];
    render();
  });

  // slot click focus
  $$("#stageBody .slot").forEach(s=>{
    s.addEventListener("click", ()=>{
      const idx = Number(s.dataset.slot);
      saved.focus = idx;
      render();
    });
  });

  // build bank pills
  const bank = $("#bankPills");
  bank.innerHTML = "";
  saved.bank.forEach(form=>{
    const used = saved.used.has(form);
    const pill = document.createElement("div");
    pill.className = "pillOpt" + (used ? " used":"");
    pill.textContent = form;
    if(used) pill.dataset.used="1";
    pill.addEventListener("click", ()=>{
      if(used || saved.graded) return;
      // fill at focus if empty, otherwise next empty after focus, otherwise next empty overall
      const target = pickTargetSlot(saved, chart);
      if(target === -1) return;
      saved.filled[target] = form;
      saved.used.add(form);
      saved.focus = Math.min(target+1, chart.forms.length-1);
      render();
    });
    bank.appendChild(pill);
  });

  // Buttons
  $("#btnNewChart").addEventListener("click", ()=>{
    saved.bank = shuffle(chart.forms.slice());
    toast("Shuffled", "Option bank reshuffled.");
    render();
  });
  $("#btnClearChart").addEventListener("click", ()=>{
    saved.filled = [];
    saved.used = new Set();
    saved.graded = false;
    saved.focus = 0;
    toast("Cleared", "Chart cleared.");
    render();
  });
  $("#btnGradeChart").addEventListener("click", ()=>{
    saved.graded = true;
    // color slots
    paintChartSlots(saved, chart);
    const total = chart.forms.length;
    const correct = chart.forms.reduce((acc, f, idx)=>acc + ((saved.filled[idx]??"")===f ? 1:0), 0);
    $("#chartStatus").textContent = `Score: ${correct}/${total}`;
    toast(correct===total ? "Perfect ‚úÖ" : "Graded", `${correct}/${total}`);
  });
  $("#btnUndo").addEventListener("click", ()=>undoChart(saved, chart));
  $("#btnUndo").disabled = saved.filled.length===0;

  $("#btnReveal").addEventListener("click", ()=>{
    const target = pickTargetSlot(saved, chart);
    if(target === -1) return;
    const correct = chart.forms[target];
    toast("Next answer", correct);
  });

  // write chart status
  $("#chartStatus").textContent = saved.graded ? "Graded. Adjust & re-grade, or reshuffle for another run." : "Fill in order, then click Grade.";

  // if graded paint immediately
  if(saved.graded) paintChartSlots(saved, chart);

  // update next button availability? (not used in chart modes)
  $("#btnNext").disabled = true;
}

function chartTableHtml(chart, slots){
  // If 6 forms (verb endings): show person rows
  if(chart.forms.length===6 && chart.labels?.length===6){
    return `
      <table class="chartTable">
        <thead>
          <tr><th>Person</th><th>Blank</th></tr>
        </thead>
        <tbody>
          ${chart.labels.map((lab, idx)=>`
            <tr><td>${escapeHtml(lab)}</td><td>${slots[idx]}</td></tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  // If 8 forms (pronoun declension): show sing/pl columns
  if(chart.forms.length===8){
    return `
      <table class="chartTable">
        <thead>
          <tr><th>Case</th><th>Singular</th><th>Plural</th></tr>
        </thead>
        <tbody>
          <tr><td>Nom.</td><td>${slots[0]}</td><td>${slots[4]}</td></tr>
          <tr><td>Gen.</td><td>${slots[1]}</td><td>${slots[5]}</td></tr>
          <tr><td>Dat.</td><td>${slots[2]}</td><td>${slots[6]}</td></tr>
          <tr><td>Acc.</td><td>${slots[3]}</td><td>${slots[7]}</td></tr>
        </tbody>
      </table>
    `;
  }

  // Generic list
  return `
    <table class="chartTable">
      <thead><tr><th>Slot</th><th>Blank</th></tr></thead>
      <tbody>
        ${chart.labels.map((lab, idx)=>`<tr><td>${escapeHtml(lab)}</td><td>${slots[idx]}</td></tr>`).join("")}
      </tbody>
    </table>
  `;
}

function pickTargetSlot(saved, chart){
  // choose focus slot if empty
  if((saved.filled[saved.focus] ?? "") === "") return saved.focus;
  // next empty after focus
  for(let j=saved.focus+1; j<chart.forms.length; j++){
    if((saved.filled[j] ?? "") === "") return j;
  }
  // any empty
  for(let j=0; j<chart.forms.length; j++){
    if((saved.filled[j] ?? "") === "") return j;
  }
  return -1;
}

function undoChart(saved, chart){
  // remove last filled slot (highest index filled)
  let last = -1;
  for(let k=chart.forms.length-1; k>=0; k--){
    if(saved.filled[k]){
      last = k; break;
    }
  }
  if(last === -1) return;
  const val = saved.filled[last];
  delete saved.filled[last];
  // rebuild used set
  saved.used = new Set(saved.filled.filter(Boolean));
  saved.graded = false;
  saved.focus = last;
  toast("Undo", `Removed: ${val}`);
  render();
}

function paintChartSlots(saved, chart){
  const slotEls = $$("#stageBody .slot");
  slotEls.forEach((el, idx)=>{
    el.classList.remove("correct","wrong");
    const got = saved.filled[idx] ?? "";
    if(!got) return;
    el.classList.add(got===chart.forms[idx] ? "correct":"wrong");
  });
  // paint bank pills too
  const pills = $$("#bankPills .pillOpt");
  pills.forEach(p=>{
    p.classList.remove("correct","wrong");
  });
}

/* ===========================
   NAV (Next/Reset)
=========================== */
function next(){
  i++;
  $("#btnNext").disabled = true;
  if(i >= session.length){
    render();
    updateTopbar();
    return;
  }
  render();
}

$("#btnNext").addEventListener("click", ()=>{
  if(mode==="vocab") return next();
  if(mode==="flash") return next();
});

$("#btnReset").addEventListener("click", ()=>{
  buildSession();
  toast("Reset", "New session started.");
});

$("#prefShuffle").addEventListener("change", buildSession);
$("#prefChoices").addEventListener("change", render);
$("#prefCardSide").addEventListener("change", render);
$("#prefSessionSize").addEventListener("change", buildSession);

/* ===========================
   Mode switching
=========================== */
$$(".modeBtn").forEach(b => b.addEventListener("click", ()=>setMode(b.dataset.mode)));

/* ===========================
   Show all vocab (simple modal-ish)
=========================== */
let allOpen = false;
const allOverlay = document.createElement("div");
allOverlay.style.cssText = `
  position: fixed; inset: 0; background: rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  padding: 18px; z-index: 9999;
`;
allOverlay.innerHTML = `
  <div style="
    width:min(980px, 100%);
    max-height: 82vh;
    overflow:auto;
    background: rgba(15,23,48,.92);
    border: 1px solid rgba(170,190,255,.18);
    border-radius: 20px;
    box-shadow: 0 18px 70px rgba(0,0,0,.5);
    backdrop-filter: blur(10px);
    padding: 14px;
  ">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; padding:6px 4px 12px; border-bottom:1px solid rgba(170,190,255,.14);">
      <div>
        <div style="font-weight:700;">All vocabulary</div>
        <div style="color:rgba(234,240,255,.72); font-size:12px;">Search and skim like a set list.</div>
      </div>
      <button class="btn" id="closeAll">Close</button>
    </div>
    <div style="padding:12px 4px;">
      <input type="text" id="allSearch" placeholder="Search Greek or English‚Ä¶" style="width:100%;"/>
      <div id="allList" style="margin-top:12px;"></div>
    </div>
  </div>
`;
document.body.appendChild(allOverlay);

function renderAllList(q=""){
  const qq = q.trim().toLowerCase();
  const list = VOCAB.filter(v => !qq || v.g.toLowerCase().includes(qq) || v.e.toLowerCase().includes(qq));
  $("#allList").innerHTML = `
    <div style="display:grid; gap:10px;">
      ${list.map(v=>`
        <div style="background:rgba(255,255,255,.03); border:1px solid rgba(170,190,255,.14); border-radius:16px; padding:12px;">
          <div style="font-size:18px; letter-spacing:.2px;">${escapeHtml(v.g)}</div>
          <div style="color:rgba(234,240,255,.72); margin-top:4px;">${escapeHtml(v.e)}</div>
        </div>
      `).join("")}
    </div>
  `;
}

function openAll(){
  allOpen = true;
  allOverlay.style.display = "flex";
  renderAllList("");
  $("#allSearch").value = "";
  $("#allSearch").focus();
}
function closeAll(){
  allOpen = false;
  allOverlay.style.display = "none";
}

$("#toggleAll").addEventListener("click", (e)=>{ e.preventDefault(); openAll(); });
allOverlay.addEventListener("click", (e)=>{
  if(e.target === allOverlay) closeAll();
});
allOverlay.querySelector("#closeAll").addEventListener("click", closeAll);
allOverlay.querySelector("#allSearch").addEventListener("input", (e)=>renderAllList(e.target.value));

/* ===========================
   Keyboard shortcuts
=========================== */
document.addEventListener("keydown", (e)=>{
  if(allOpen && e.key === "Escape") return closeAll();

  if(e.key.toLowerCase()==="r"){
    if(mode==="vocab" || mode==="flash") buildSession();
    else render(); // chart reshuffle done via button; keep simple
  }
  if(e.key.toLowerCase()==="n"){
    if(mode==="vocab" && !$("#btnNext").disabled) next();
    if(mode==="flash") next();
  }
  if(e.code==="Space"){
    if(mode==="flash"){
      e.preventDefault();
      const card = $("#flashCard");
      if(card) card.click();
    }
  }

  // MC number keys
  if(mode==="vocab"){
    const n = Number(e.key);
    if(n>=1 && n<=6){
      const btn = $(`#mcGrid .opt[data-idx="${n-1}"]`);
      if(btn && !btn.disabled) btn.click();
    }
  }

  // Chart undo
  if(e.key.toLowerCase()==="u"){
    if(mode==="verbs" || mode==="pronouns" || mode==="endings"){
      const key = `__chart_${mode}`;
      const saved = window[key];
      const charts = mode==="verbs" ? VERB_CHARTS : (mode==="pronouns" ? PRONOUN_CHARTS : ENDING_CHARTS);
      const chart = charts.find(c=>c.id===saved.chartId) || charts[0];
      undoChart(saved, chart);
    }
  }
});

/* ===========================
   Utilities
=========================== */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===========================
   INIT
=========================== */
buildSession();
setMode("vocab");
</script>
</body>
</html>
