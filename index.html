<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Koine Greek</title>
<style>
:root{--bg:#fff;--fg:#111;--mut:#666;--line:#e8e8e8;--ok:#137333;--bad:#b3261e;--r:14px;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit}
.wrap{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:320px 1fr;gap:14px}
@media(max-width:900px){.wrap{grid-template-columns:1fr}}
.panel{border:1px solid var(--line);border-radius:var(--r);overflow:hidden;background:#fff}
.head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
.brand{font-weight:800}
.search{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;outline:none}
.search:focus{border-color:#111}
.side{padding:10px;max-height:calc(100vh - 110px);overflow:auto}
.group{margin:10px 0 6px;color:var(--mut);font-size:12px;letter-spacing:.08em;text-transform:uppercase}
.item{width:100%;text-align:left;padding:10px 12px;border:1px solid transparent;border-radius:12px;background:transparent;cursor:pointer}
.item:hover{background:#f6f6f6}
.item.active{background:#111;color:#fff}
.mainTop{padding:12px 14px;border-bottom:1px solid var(--line)}
.h1{font-weight:900;font-size:16px;margin:0}
.sub{margin:6px 0 0;color:var(--mut);font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.btn{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn:hover{background:#f6f6f6}
.btn.primary{background:#111;color:#fff;border-color:#111}
.btn.primary:hover{background:#000}
.select,.input{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
.select:focus,.input:focus{border-color:#111}
.input.ok{border-color:rgba(19,115,51,.6);box-shadow:0 0 0 3px rgba(19,115,51,.08)}
.input.bad{border-color:rgba(179,38,30,.6);box-shadow:0 0 0 3px rgba(179,38,30,.08)}
.card{padding:14px}
.big{font-size:34px;letter-spacing:.3px;margin:2px 0 0}
.fb{margin-top:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fafafa;display:none}
.fb.ok{border-color:rgba(19,115,51,.45);background:rgba(19,115,51,.06)}
.fb.bad{border-color:rgba(179,38,30,.45);background:rgba(179,38,30,.06)}
.grid{margin-top:10px;display:grid;gap:10px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.opt{text-align:left;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;cursor:pointer}
.opt:hover{background:#f6f6f6}
.opt.correct{border-color:rgba(19,115,51,.5);background:rgba(19,115,51,.06)}
.opt.wrong{border-color:rgba(179,38,30,.5);background:rgba(179,38,30,.06)}
.table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden}
.table td,.table th{border-bottom:1px solid var(--line);border-right:1px solid var(--line);padding:10px;vertical-align:middle}
.table tr:last-child td{border-bottom:none}
.table td:last-child,.table th:last-child{border-right:none}
.table th{background:#fafafa;color:var(--mut);font-size:12px;text-transform:uppercase;letter-spacing:.06em}
.slot{display:inline-flex;align-items:center;justify-content:center;min-width:90px;padding:8px 10px;border:1px dashed #bdbdbd;border-radius:12px;color:var(--mut);cursor:pointer;user-select:none}
.slot.filled{border-style:solid;color:var(--fg)}
.slot.active{outline:2px solid #111;outline-offset:2px}
.slot.correct{border-color:rgba(19,115,51,.6);background:rgba(19,115,51,.06)}
.slot.wrong{border-color:rgba(179,38,30,.6);background:rgba(179,38,30,.06)}
.bank{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.pill:hover{background:#f6f6f6}
.pill.used{opacity:.4;cursor:not-allowed}
.small{color:var(--mut);font-size:12px}
textarea{width:100%;min-height:160px;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;outline:none}
textarea:focus{border-color:#111}
</style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <div class="head">
      <div class="brand">Koine Greek</div>
      <div class="small" id="meta"></div>
    </div>
    <div class="card" style="border-bottom:1px solid var(--line)">
      <input id="q" class="search" placeholder="Search (e.g., Demonstrative Pronouns)"/>
    </div>
    <div class="side" id="side"></div>
  </aside>

  <main class="panel">
    <div class="mainTop">
      <div class="h1" id="title">—</div>
      <div class="sub" id="sub">—</div>
    </div>
    <div class="card" id="main"></div>
  </main>
</div>

<script>
const DATA = {"vocab":[{"g":"ὁ","e":"the (masculine)"},{"g":"ἡ","e":"the (feminine)"},{"g":"τό","e":"the (neuter)"},{"g":"καί","e":"and"},{"g":"δέ","e":"but, and"},{"g":"ἀλλά","e":"but"},{"g":"γάρ","e":"for"},{"g":"οὐ","e":"not"},{"g":"ἐν","e":"in"},{"g":"ἐκ","e":"out of"},{"g":"εἰς","e":"into"},{"g":"πρός","e":"to, toward"},{"g":"ἀπό","e":"from"},{"g":"διά","e":"through, because of"},{"g":"ὑπέρ","e":"for, on behalf of"},{"g":"περί","e":"about, concerning"},{"g":"μετά","e":"with, after"},{"g":"ἐπί","e":"on, upon"},{"g":"κατά","e":"according to, against"},{"g":"ἄν","e":"(modal particle)"},{"g":"οὖν","e":"therefore"},{"g":"ἀμήν","e":"amen, truly"},{"g":"οὐδέ","e":"and not, nor"},{"g":"μή","e":"not"},{"g":"ἵνα","e":"in order that"},{"g":"ὅτι","e":"that, because"},{"g":"εἰ","e":"if"},{"g":"ἐάν","e":"if"},{"g":"ὅταν","e":"whenever"},{"g":"ὅπως","e":"so that"},{"g":"οὐκέτι","e":"no longer"},{"g":"νῦν","e":"now"},{"g":"τότε","e":"then"},{"g":"πάλιν","e":"again"},{"g":"ἤδη","e":"already"},{"g":"ἔτι","e":"still, yet"},{"g":"ἄρτι","e":"now"},{"g":"πῶς","e":"how?"},{"g":"τίς","e":"who?"},{"g":"τί","e":"what?"},{"g":"ποῦ","e":"where?"},{"g":"πότε","e":"when?"},{"g":"πόσος","e":"how much?"},{"g":"ὅς","e":"who, which"},{"g":"ὅς/ἥ/ὅ","e":"who/which"},{"g":"ὅστις","e":"whoever"},{"g":"οὗτος","e":"this"},{"g":"ἐκεῖνος","e":"that"},{"g":"αὐτός","e":"he, she, it; same"},{"g":"ἐγώ","e":"I"},{"g":"σύ","e":"you"},{"g":"ἡμεῖς","e":"we"},{"g":"ὑμεῖς","e":"you (pl.)"},{"g":"οἶκος","e":"house"},{"g":"ἄνθρωπος","e":"man, person"},{"g":"θεός","e":"God"},{"g":"κύριος","e":"Lord"},{"g":"υἱός","e":"son"},{"g":"βασιλεία","e":"kingdom"},{"g":"ὄνομα","e":"name"},{"g":"λόγος","e":"word"},{"g":"ἔργον","e":"work"},{"g":"γραφὴ","e":"Scripture"},{"g":"πνεῦμα","e":"spirit"},{"g":"σάρξ","e":"flesh"},{"g":"κόσμος","e":"world"},{"g":"ζωή","e":"life"},{"g":"ψυχή","e":"soul"},{"g":"καρδία","e":"heart"},{"g":"ἁμαρτία","e":"sin"},{"g":"πίστις","e":"faith"},{"g":"ἀγάπη","e":"love"},{"g":"χάρις","e":"grace"},{"g":"δόξα","e":"glory"},{"g":"δύναμις","e":"power"},{"g":"Ἰσραήλ","e":"Israel"},{"g":"Ἰουδαῖοι","e":"Jews"},{"g":"Ἰουδαία","e":"Judea"},{"g":"Ἰερουσαλήμ","e":"Jerusalem"},{"g":"βασιλεύς","e":"king"},{"g":"ὄχλος","e":"crowd"},{"g":"Φαρισαῖος","e":"Pharisee"},{"g":"συναγωγή","e":"synagogue"},{"g":"θρόνος","e":"throne"},{"g":"γῆ","e":"earth"},{"g":"ὄρος","e":"mountain/hill"},{"g":"αἷμα","e":"blood"},{"g":"πῦρ","e":"fire"},{"g":"ἱμάτιον","e":"garment"},{"g":"ποῦς","e":"foot"},{"g":"κεφαλή","e":"head"},{"g":"λέγω","e":"I speak/say"},{"g":"ἀκολουθέω","e":"I follow"},{"g":"διδάσκω","e":"I teach"},{"g":"ἐπερωτάω","e":"I ask"},{"g":"ἐρωτάω","e":"I ask"},{"g":"θέλω","e":"I wish/desire"},{"g":"περιτατέω","e":"I live/walk"},{"g":"ἀποθνῇσκω","e":"I die"},{"g":"βάλλω","e":"I throw"},{"g":"γίνομαι","e":"I become"},{"g":"εἰσέρχομαι","e":"I come/go to"},{"g":"ἐξέρχομαι","e":"I come/go out"},{"g":"εὑρίσκω","e":"I find"},{"g":"λαμβάνω","e":"I take"},{"g":"προσέρχομαι","e":"I come/go to"},{"g":"προσεύχομαι","e":"I pray"},{"g":"ἀπέρχομαι","e":"I depart"},{"g":"ἂρχομαι","e":"I begin"},{"g":"γράφω","e":"I write"},{"g":"δοξάζω","e":"I glorify"},{"g":"κηρύσσω","e":"I proclaim/preach"},{"g":"πίνω","e":"I drink"},{"g":"ἂγω","e":"I lead/bring"},{"g":"ὑπάγω","e":"I go to"},{"g":"μαρτυρέω","e":"I bear witness to"},{"g":"χαίρω","e":"I rejoice"},{"g":"φοβέομαι","e":"I fear"},{"g":"ἐρωτάω","e":"I ask"},{"g":"ἀποκρίνομαι","e":"I answer"},{"g":"ζητέω","e":"I seek"},{"g":"σῴζω","e":"I save"},{"g":"ἔρχομαι","e":"I come/go"},{"g":"ἀκούω","e":"I hear"},{"g":"καλέω","e":"I call"},{"g":"ἔχω","e":"I have"},{"g":"γινώσκω","e":"I know"},{"g":"ποιέω","e":"I do/make"},{"g":"ἀπολλύω","e":"I destroy"},{"g":"πληρόω","e":"I fulfill"},{"g":"δύναμαι","e":"I am able"},{"g":"δεῖ","e":"it is necessary"},{"g":"λέλυκα","e":"I have loosed"},{"g":"ὄψομαι","e":"I will see"}],"verbs":[{"lemma":"εἰμί","principalParts":["","","","","",""]},{"lemma":"λέγω","principalParts":["","","","","",""]},{"lemma":"ἀκολουθέω","principalParts":["","","","","",""]},{"lemma":"διδάσκω","principalParts":["","","","","",""]},{"lemma":"ἐπερωτάω","principalParts":["","","","","",""]},{"lemma":"ἐρωτάω","principalParts":["","","","","",""]},{"lemma":"θέλω","principalParts":["","","","","",""]},{"lemma":"περιτατέω","principalParts":["","","","","",""]},{"lemma":"ἀποθνῇσκω","principalParts":["","","","","",""]},{"lemma":"βάλλω","principalParts":["","","","","",""]},{"lemma":"γίνομαι","principalParts":["","","","","",""]},{"lemma":"εἰσέρχομαι","principalParts":["","","","","",""]},{"lemma":"ἐξέρχομαι","principalParts":["","","","","",""]},{"lemma":"εὑρίσκω","principalParts":["","","","","",""]},{"lemma":"λαμβάνω","principalParts":["","","","","",""]},{"lemma":"προσέρχομαι","principalParts":["","","","","",""]},{"lemma":"προσεύχομαι","principalParts":["","","","","",""]},{"lemma":"ἀπέρχομαι","principalParts":["","","","","",""]},{"lemma":"ἂρχομαι","principalParts":["","","","","",""]},{"lemma":"γράφω","principalParts":["","","","","",""]},{"lemma":"δοξάζω","principalParts":["","","","","",""]},{"lemma":"κηρύσσω","principalParts":["","","","","",""]},{"lemma":"πίνω","principalParts":["","","","","",""]},{"lemma":"ἂγω","principalParts":["","","","","",""]},{"lemma":"ὑπάγω","principalParts":["","","","","",""]},{"lemma":"μαρτυρέω","principalParts":["","","","","",""]},{"lemma":"χαίρω","principalParts":["","","","","",""]},{"lemma":"φοβέομαι","principalParts":["","","","","",""]},{"lemma":"ἀποκρίνομαι","principalParts":["","","","","",""]},{"lemma":"ζητέω","principalParts":["","","","","",""]},{"lemma":"σῴζω","principalParts":["","","","","",""]},{"lemma":"ἔρχομαι","principalParts":["","","","","",""]},{"lemma":"ἀκούω","principalParts":["","","","","",""]},{"lemma":"καλέω","principalParts":["","","","","",""]},{"lemma":"ἔχω","principalParts":["","","","","",""]},{"lemma":"γινώσκω","principalParts":["","","","","",""]}],"charts":[{"title":"Present Active Indicative","matrix":[["Present Active Indicative"],["λύω"],["λύεις"],["λύει"],["λύομεν"],["λύετε"],["λύουσι(ν)"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λύω","λύεις","λύει","λύομεν","λύετε","λύουσι(ν)"],"id":"Verb Conjugations_01","group":"Verb Conjugations"},{"title":"Present Middle/Passive Indicative","matrix":[["Present Middle/Passive Indicative"],["λύομαι"],["λύῃ"],["λύεται"],["λυόμεθα"],["λύεσθε"],["λύονται"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λύομαι","λύῃ","λύεται","λυόμεθα","λύεσθε","λύονται"],"id":"Verb Conjugations_02","group":"Verb Conjugations"},{"title":"Future Active Indicative","matrix":[["Future Active Indicative"],["λύσω"],["λύσεις"],["λύσει"],["λύσομεν"],["λύσετε"],["λύσουσι(ν)"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λύσω","λύσεις","λύσει","λύσομεν","λύσετε","λύσουσι(ν)"],"id":"Verb Conjugations_03","group":"Verb Conjugations"},{"title":"Future Middle Indicative","matrix":[["Future Middle Indicative"],["λύσομαι"],["λύσῃ"],["λύσεται"],["λυσόμεθα"],["λύσεσθε"],["λύσονται"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λύσομαι","λύσῃ","λύσεται","λυσόμεθα","λύσεσθε","λύσονται"],"id":"Verb Conjugations_04","group":"Verb Conjugations"},{"title":"Future Passive Indicative","matrix":[["Future Passive Indicative"],["λυθήσομαι"],["λυθήσῃ"],["λυθήσεται"],["λυθησόμεθα"],["λυθήσεσθε"],["λυθήσονται"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λυθήσομαι","λυθήσῃ","λυθήσεται","λυθησόμεθα","λυθήσεσθε","λυθήσονται"],"id":"Verb Conjugations_05","group":"Verb Conjugations"},{"title":"Imperfect Active Indicative","matrix":[["Imperfect Active Indicative"],["ἔλυον"],["ἔλυες"],["ἔλυε(ν)"],["ἐλύομεν"],["ἐλύετε"],["ἔλυον"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["ἔλυον","ἔλυες","ἔλυε(ν)","ἐλύομεν","ἐλύετε","ἔλυον"],"id":"Verb Conjugations_06","group":"Verb Conjugations"},{"title":"Aorist Active Indicative","matrix":[["Aorist Active Indicative"],["ἔλυσα"],["ἔλυσας"],["ἔλυσε(ν)"],["ἐλύσαμεν"],["ἐλύσατε"],["ἔλυσαν"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["ἔλυσα","ἔλυσας","ἔλυσε(ν)","ἐλύσαμεν","ἐλύσατε","ἔλυσαν"],"id":"Verb Conjugations_07","group":"Verb Conjugations"},{"title":"Perfect Active Indicative","matrix":[["Perfect Active Indicative"],["λέλυκα"],["λέλυκας"],["λέλυκε(ν)"],["λελύκαμεν"],["λελύκατε"],["λελύκασι(ν)"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λέλυκα","λέλυκας","λέλυκε(ν)","λελύκαμεν","λελύκατε","λελύκασι(ν)"],"id":"Verb Conjugations_08","group":"Verb Conjugations"},{"title":"Perfect Middle/Passive Indicative","matrix":[["Perfect Middle/Passive Indicative"],["λέλυμαι"],["λέλυσαι"],["λέλυται"],["λελύμεθα"],["λέλυσθε"],["λέλυνται"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["λέλυμαι","λέλυσαι","λέλυται","λελύμεθα","λέλυσθε","λέλυνται"],"id":"Verb Conjugations_09","group":"Verb Conjugations"},{"title":"Aorist Passive Indicative","matrix":[["Aorist Passive Indicative"],["ἐλύθην"],["ἐλύθης"],["ἐλύθη"],["ἐλύθημεν"],["ἐλύθητε"],["ἐλύθησαν"]],"coords":[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0]],"answers":["ἐλύθην","ἐλύθης","ἐλύθη","ἐλύθημεν","ἐλύθητε","ἐλύθησαν"],"id":"Verb Conjugations_10","group":"Verb Conjugations"},{"title":"Relative Pronoun","matrix":[["Relative Pronoun","","",""],["","Masculine","Feminine","Neuter"],["SINGULAR","Nominative","ὅς","ἥ","ὅ"],["","Genitive","οὗ","ἧς","οὗ"],["","Dative","ᾧ","ᾗ","ᾧ"],["","Accusative","ὅν","ἥν","ὅ"],["PLURAL","Nominative","οἵ","αἵ","ἅ"],["","Genitive","ὧν","ὧν","ὧν"],["","Dative","οἷς","αἷς","οἷς"],["","Accusative","οὕς","ἅς","ἅ"]],"coords":[[2,2],[2,3],[2,4],[3,2],[3,3],[3,4],[4,2],[4,3],[4,4],[5,2],[5,3],[5,4],[6,2],[6,3],[6,4],[7,2],[7,3],[7,4],[8,2],[8,3],[8,4],[9,2],[9,3],[9,4]],"answers":["ὅς","ἥ","ὅ","οὗ","ἧς","οὗ","ᾧ","ᾗ","ᾧ","ὅν","ἥν","ὅ","οἵ","αἵ","ἅ","ὧν","ὧν","ὧν","οἷς","αἷς","οἷς","οὕς","ἅς","ἅ"],"id":"Pronouns and Adjectives_01","group":"Pronouns and Adjectives"},{"title":"ARTICLE ENDING","matrix":[["ARTICLE ENDING","","","",""],["","Case","Masculine","Feminine","Neuter"],["SINGULAR","Nominative","ὁ","ἡ","τό"],["","Genitive","τοῦ","τῆς","τοῦ"],["","Dative","τῷ","τῇ","τῷ"],["","Accusative","τόν","τήν","τό"],["PLURAL","Nominative","οἱ","αἱ","τά"],["","Genitive","τῶν","τῶν","τῶν"],["","Dative","τοῖς","ταῖς","τοῖς"],["","Accusative","τούς","τάς","τά"]],"coords":[[2,2],[2,3],[2,4],[3,2],[3,3],[3,4],[4,2],[4,3],[4,4],[5,2],[5,3],[5,4],[6,2],[6,3],[6,4],[7,2],[7,3],[7,4],[8,2],[8,3],[8,4],[9,2],[9,3],[9,4]],"answers":["ὁ","ἡ","τό","τοῦ","τῆς","τοῦ","τῷ","τῇ","τῷ","τόν","τήν","τό","οἱ","αἱ","τά","τῶν","τῶν","τῶν","τοῖς","ταῖς","τοῖς","τούς","τάς","τά"],"id":"Nonverb Endings_01","group":"Nonverb Endings"}]};

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const norm = s => String(s||"").toLowerCase().replace(/\u00a0/g," ").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
const shuffle = a => { const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]];} return x; };
function buildAccept(eng){
  const raw=String(eng||"");
  const parts=raw.split(/[,;\/]|\bor\b/gi).map(x=>x.trim()).filter(Boolean);
  const set=new Set([norm(raw)]);
  for(const p of parts) set.add(norm(p));
  return set;
}

const LS_VERBS="kg_verbs_min_v1";
function loadVerbs(){ try{const r=localStorage.getItem(LS_VERBS); if(r) return JSON.parse(r);}catch(e){} return DATA.verbs.slice(); }
function saveVerbs(v){ localStorage.setItem(LS_VERBS, JSON.stringify(v)); }

const ACTIVITIES = (()=> {
  const out=[];
  out.push({id:"vocab", group:"Vocab", title:"Vocab Quiz", type:"vocab"});
  out.push({id:"verbs", group:"Verbs", title:"Verbs", type:"verbs"});
  for(const c of DATA.charts) out.push({id:"chart_"+c.id, group:c.group, title:c.title, type:"chart", chartId:c.id});
  return out;
})();

let active="vocab";
let state={ idx:0, score:0, streak:0, locked:false, qtype:"fill", mc:4, chart:null, filled:[], used:new Set(), focus:0, graded:false, bank:[], verbs:[] };

function header(t,s){ $("#title").textContent=t; $("#sub").textContent=s; }
function renderSidebar(){
  const q=$("#q").value.trim().toLowerCase();
  const items = !q ? ACTIVITIES : ACTIVITIES.filter(a=>a.title.toLowerCase().includes(q) || a.group.toLowerCase().includes(q));
  const by=new Map();
  for(const it of items){ if(!by.has(it.group)) by.set(it.group,[]); by.get(it.group).push(it); }
  const side=$("#side"); side.innerHTML="";
  for(const [g, arr] of by.entries()){
    const h=document.createElement("div"); h.className="group"; h.textContent=g; side.appendChild(h);
    arr.sort((a,b)=>a.title.localeCompare(b.title));
    for(const it of arr){
      const b=document.createElement("button");
      b.className="item"+(it.id===active?" active":"");
      b.textContent=it.title;
      b.onclick=()=>{ active=it.id; reset(); renderSidebar(); renderMain(); };
      side.appendChild(b);
    }
  }
  $("#meta").textContent = `${DATA.vocab.length} vocab • ${DATA.charts.length} charts`;
}
$("#q").addEventListener("input", renderSidebar);

function getAct(){ return ACTIVITIES.find(a=>a.id===active); }
function reset(){
  state.idx=0; state.score=0; state.streak=0; state.locked=false; state.filled=[]; state.used=new Set(); state.focus=0; state.graded=false;
  const a=getAct();
  if(a.type==="chart"){
    state.chart = DATA.charts.find(c=>("chart_"+c.id)===a.id) || DATA.charts.find(c=>c.id===a.chartId);
    state.bank = state.chart ? shuffle(state.chart.answers) : [];
  } else if(a.type==="verbs"){
    state.verbs = loadVerbs();
  }
}

function renderQuiz({promptLabel, prompt, answer, acceptable, pool}){
  const main=$("#main");
  const qtype=state.qtype;
  const mcN=Math.max(3,Math.min(6,state.mc));

  const controls = `
    <div class="row" style="margin-bottom:10px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select class="select" id="qtype">
          <option value="fill" ${qtype==="fill"?"selected":""}>Fill</option>
          <option value="mc" ${qtype==="mc"?"selected":""}>MC</option>
          <option value="tf" ${qtype==="tf"?"selected":""}>T/F</option>
        </select>
        <select class="select" id="mcN">
          ${[3,4,5,6].map(n=>`<option value="${n}" ${n===mcN?"selected":""}>${n} choices</option>`).join("")}
        </select>
      </div>
      <button class="btn" id="peek">Peek</button>
    </div>
  `;

  if(qtype==="fill"){
    main.innerHTML = controls + `
      <div class="small">${promptLabel}</div>
      <div class="big">${prompt}</div>
      <form id="f" style="margin-top:12px">
        <input id="in" class="input" placeholder="Answer…" autocomplete="off"/>
      </form>
      <div id="fb" class="fb"></div>
      <div class="row" style="margin-top:12px">
        <div class="small">Enter = submit</div>
        <button class="btn primary" id="next" disabled>Next</button>
      </div>
    `;
    $("#qtype").onchange=e=>{state.qtype=e.target.value; renderMain();};
    $("#mcN").onchange=e=>{state.mc=Number(e.target.value); renderMain();};
    $("#peek").onclick=()=>alert(answer);

    const inp=$("#in"), fb=$("#fb"), next=$("#next");
    inp.focus();

    function grade(){
      if(state.locked) return;
      const guess=norm(inp.value);
      const ok = acceptable ? acceptable.has(guess) : norm(answer)===guess;
      state.locked=true;
      fb.style.display="block";
      if(ok){
        inp.classList.add("ok"); fb.className="fb ok"; fb.innerHTML=`<b style="color:var(--ok)">Correct</b> • ${answer}`;
        state.score++; state.streak++;
      } else {
        inp.classList.add("bad"); fb.className="fb bad"; fb.innerHTML=`<b style="color:var(--bad)">Wrong</b> • ${answer}`;
        state.streak=0;
      }
      next.disabled=false;
    }
    $("#f").onsubmit=e=>{e.preventDefault(); grade();};
    next.onclick=()=>{state.idx++; state.locked=false; renderMain();};
    return;
  }

  if(qtype==="mc"){
    const opts = shuffle([answer, ...shuffle(pool.filter(x=>x!==answer)).slice(0, mcN-1)]);
    main.innerHTML = controls + `
      <div class="small">${promptLabel}</div>
      <div class="big">${prompt}</div>
      <div class="grid" id="grid">${opts.map((o,i)=>`<button class="opt" data-i="${i}" data-ok="${o===answer?1:0}">${o}</button>`).join("")}</div>
      <div class="row" style="margin-top:12px">
        <div class="small">Click an option</div>
        <button class="btn primary" id="next" disabled>Next</button>
      </div>
    `;
    $("#qtype").onchange=e=>{state.qtype=e.target.value; renderMain();};
    $("#mcN").onchange=e=>{state.mc=Number(e.target.value); renderMain();};
    $("#peek").onclick=()=>alert(answer);

    const btns=$$("#grid .opt"), next=$("#next");
    btns.forEach(b=>b.onclick=()=>{
      if(state.locked) return;
      state.locked=true;
      btns.forEach(x=>x.disabled=true);
      const ok=b.dataset.ok==="1";
      if(ok){b.classList.add("correct"); state.score++; state.streak++;}
      else {b.classList.add("wrong"); state.streak=0; const c=btns.find(x=>x.dataset.ok==="1"); if(c) c.classList.add("correct");}
      next.disabled=false;
    });
    next.onclick=()=>{state.idx++; state.locked=false; renderMain();};
    return;
  }

  // tf
  const isTrue=Math.random()<0.5;
  const shown = isTrue ? answer : (shuffle(pool.filter(x=>x!==answer))[0] || answer);
  main.innerHTML = controls + `
    <div class="small">${promptLabel}</div>
    <div class="big">${prompt}</div>
    <div style="margin-top:10px"><b>${shown}</b></div>
    <div class="row" style="margin-top:12px">
      <div style="display:flex;gap:8px">
        <button class="btn" id="t">True</button>
        <button class="btn" id="f">False</button>
      </div>
      <button class="btn primary" id="next" disabled>Next</button>
    </div>
    <div id="fb" class="fb"></div>
  `;
  $("#qtype").onchange=e=>{state.qtype=e.target.value; renderMain();};
  $("#mcN").onchange=e=>{state.mc=Number(e.target.value); renderMain();};
  $("#peek").onclick=()=>alert(answer);

  const fb=$("#fb"), next=$("#next");
  function grade(choice){
    if(state.locked) return;
    state.locked=true;
    const ok = (choice===isTrue);
    fb.style.display="block";
    if(ok){fb.className="fb ok"; fb.innerHTML=`<b style="color:var(--ok)">Correct</b>`; state.score++; state.streak++;}
    else {fb.className="fb bad"; fb.innerHTML=`<b style="color:var(--bad)">Wrong</b> • ${answer}`; state.streak=0;}
    next.disabled=false;
  }
  $("#t").onclick=()=>grade(true);
  $("#f").onclick=()=>grade(false);
  next.onclick=()=>{state.idx++; state.locked=false; renderMain();};
}

function renderVocab(){
  const list=DATA.vocab;
  const cur=list[state.idx];
  if(!cur){ header("Vocab Quiz", `Score ${state.score} / ${list.length}`); $("#main").innerHTML = `<button class="btn primary" id="again">Again</button>`; $("#again").onclick=()=>{reset(); renderMain();}; return; }
  header("Vocab Quiz", `${state.idx+1} / ${list.length} • Score ${state.score} • Streak ${state.streak}`);
  renderQuiz({ promptLabel:"Greek", prompt:cur.g, answer:cur.e, acceptable: buildAccept(cur.e), pool: DATA.vocab.map(v=>v.e) });
}

function renderChart(){
  const a=getAct();
  const chart = DATA.charts.find(c=>("chart_"+c.id)===a.id) || DATA.charts.find(c=>c.id===a.chartId);
  if(!chart){ header("Chart","Not found"); $("#main").textContent=""; return; }
  header(chart.title, chart.group);

  const coordSet=new Set(chart.coords.map(x=>x[0]+","+x[1]));
  const filled = state.filled || [];
  const focus = state.focus||0;

  function cellHtml(r,c,text){
    const key=r+","+c;
    if(coordSet.has(key)){
      const idx = chart.coords.findIndex(p=>p[0]===r && p[1]===c);
      const val = filled[idx] || "";
      const cls=["slot", val?"filled":"", idx===focus?"active":"", state.graded?(val===chart.answers[idx]?"correct":"wrong"):""].join(" ").trim();
      return `<td><span class="${cls}" data-slot="${idx}">${val||"_____"}</span></td>`;
    }
    return `<td>${text}</td>`;
  }

  const rows = chart.matrix.map((row,r)=>`<tr>${row.map((cell,c)=>cellHtml(r,c,cell)).join("")}</tr>`).join("");
  const bank = state.bank && state.bank.length ? state.bank : shuffle(chart.answers);
  const used = new Set((state.filled||[]).filter(Boolean));

  $("#main").innerHTML = `
    <div class="row" style="margin-bottom:10px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="clear">Clear</button>
        <button class="btn" id="shuffle">Shuffle</button>
        <button class="btn primary" id="grade">Grade</button>
      </div>
      <div class="small">${(state.filled||[]).filter(Boolean).length} / ${chart.answers.length}</div>
    </div>
    <table class="table">${rows}</table>
    <div class="bank" id="bank"></div>
  `;

  $$("#main .slot").forEach(s=>s.onclick=()=>{ state.focus=Number(s.dataset.slot); renderChart(); });

  $("#clear").onclick=()=>{ state.filled=[]; state.used=new Set(); state.focus=0; state.graded=false; state.bank=shuffle(chart.answers); renderChart(); };
  $("#shuffle").onclick=()=>{ state.bank=shuffle(chart.answers); renderChart(); };
  $("#grade").onclick=()=>{ state.graded=true; renderChart(); };

  const bankEl=$("#bank"); bankEl.innerHTML="";
  bank.forEach(opt=>{
    const b=document.createElement("button");
    b.className="pill"+(used.has(opt)?" used":"");
    b.textContent=opt;
    b.disabled=used.has(opt);
    b.onclick=()=>{
      if(state.graded) return;
      const i=state.focus;
      if(state.filled[i]) return;
      state.filled[i]=opt;
      let j=i+1; while(j<chart.answers.length && state.filled[j]) j++;
      if(j>=chart.answers.length) j=state.filled.findIndex(x=>!x);
      state.focus = (j===-1)?i:j;
      renderChart();
    };
    bankEl.appendChild(b);
  });
}

function stripEnding(w, ending){ return w.endsWith(ending)?w.slice(0,-ending.length):w; }
function genForms(lemma, kind, pp){
  const pp2=pp[1]||"", pp3=pp[2]||"", pp4=pp[3]||"", pp5=pp[4]||"", pp6=pp[5]||"";
  const stem1=stripEnding(lemma,"ω");
  const presA=["ω","εις","ει","ομεν","ετε","ουσι(ν)"].map(e=>stem1+e);
  const presMP=["ομαι","ῃ","εται","ομεθα","εσθε","ονται"].map(e=>stem1+e);
  if(kind==="presA") return presA;
  if(kind==="presMP") return presMP;

  if(kind==="futA" && pp3){const s=stripEnding(pp3,"ω"); return ["ω","εις","ει","ομεν","ετε","ουσι(ν)"].map(e=>s+e);}
  if(kind==="impA" && pp2){let s=pp2; if(s.endsWith("ον")) s=s.slice(0,-2); return ["ον","ες","ε(ν)","ομεν","ετε","ον"].map(e=>s+e);}
  if(kind==="aorA" && pp4){let s=pp4; if(s.endsWith("α")) s=s.slice(0,-1); return ["α","ας","ε(ν)","αμεν","ατε","αν"].map(e=>s+e);}
  if(kind==="perfMP" && pp5){const s=stripEnding(pp5,"μαι"); return ["μαι","σαι","ται","μεθα","σθε","νται"].map(e=>s+e);}
  if(kind==="aorP" && pp6){let s=pp6; if(s.endsWith("ην")) s=s.slice(0,-2); return ["ην","ης","η","ημεν","ητε","ησαν"].map(e=>s+e);}
  return null;
}

function renderVerbs(){
  const verbs = state.verbs = loadVerbs();
  header("Verbs","Edit principal parts as needed.");
  const main=$("#main");

  const verbList = verbs.map((v,i)=>`<option value="${i}">${v.lemma}</option>`).join("");
  main.innerHTML = `
    <div class="row" style="margin-bottom:10px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select class="select" id="verbSel" style="min-width:220px">${verbList}</select>
        <select class="select" id="vt">
          <option value="presA">Present Active</option>
          <option value="presMP">Present Mid/Pass</option>
          <option value="futA">Future Active</option>
          <option value="impA">Imperfect Active</option>
          <option value="aorA">Aorist Active</option>
          <option value="perfMP">Perfect Mid/Pass</option>
          <option value="aorP">Aorist Passive</option>
        </select>
        <select class="select" id="qtype">
          <option value="fill">Fill</option>
          <option value="mc">MC</option>
          <option value="tf">T/F</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="manage">Manage</button>
        <button class="btn primary" id="start">Start</button>
      </div>
    </div>
    <div id="practice"></div>
    <div id="mgr" style="display:none;margin-top:12px">
      <div class="small">One per line: lemma | pp1, pp2, pp3, pp4, pp5, pp6</div>
      <textarea id="editor" spellcheck="false"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="resetList">Reset list</button>
        <button class="btn primary" id="save">Save</button>
      </div>
    </div>
  `;

  $("#qtype").onchange=e=>{ state.qtype=e.target.value; };
  const mgr=$("#mgr");

  $("#manage").onclick=()=>{
    mgr.style.display = (mgr.style.display==="none") ? "block":"none";
    if(mgr.style.display==="block"){
      $("#editor").value = verbs.map(v=>`${v.lemma} | ${(v.principalParts||[]).join(", ")}`).join("\n");
    }
  };

  $("#resetList").onclick=()=>{ localStorage.removeItem(LS_VERBS); state.verbs=DATA.verbs.slice(); saveVerbs(state.verbs); renderVerbs(); };

  $("#save").onclick=()=>{
    const text=$("#editor").value.trim();
    const lines = text ? text.split(/\n+/) : [];
    const list=[];
    for(const line of lines){
      const [lem, rest] = line.split("|");
      const lemma=(lem||"").trim();
      if(!lemma) continue;
      const pp = (rest||"").split(",").map(x=>x.trim());
      while(pp.length<6) pp.push("");
      list.push({lemma, principalParts:pp.slice(0,6)});
    }
    saveVerbs(list);
    renderVerbs();
  };

  function run(){
    const idx=Number($("#verbSel").value||0);
    const v=verbs[idx];
    const kind=$("#vt").value;
    const qtype=$("#qtype").value;
    state.qtype=qtype;
    const pp=v.principalParts||["","","","","",""];
    const forms=genForms(v.lemma, kind, pp);
    const host=$("#practice");
    if(!forms){
      host.innerHTML = `<div class="fb bad" style="display:block"><b>Missing principal parts for this tense.</b></div>`;
      return;
    }
    const labels=["1st sg","2nd sg","3rd sg","1st pl","2nd pl","3rd pl"];
    if(state.idx>=forms.length) state.idx=0;
    const i=state.idx;
    header("Verbs", `${v.lemma} • ${$("#vt").selectedOptions[0].textContent} • ${i+1}/6`);
    renderQuiz({ promptLabel:"Person", prompt: labels[i], answer: forms[i], acceptable: new Set([norm(forms[i])]), pool: forms });
  }

  $("#start").onclick=()=>{ state.idx=0; state.score=0; state.streak=0; state.locked=false; run(); };
}

function renderMain(){
  const a=getAct();
  if(a.type==="vocab") return renderVocab();
  if(a.type==="chart") return renderChart();
  if(a.type==="verbs") return renderVerbs();
}

renderSidebar();
reset();
renderMain();
</script>
</body>
</html>
